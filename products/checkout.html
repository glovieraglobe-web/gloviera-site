<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Gloviéra Checkout</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Vesper+Libre:wght@400;500;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <script>
    window.__GLOVIERA_CONFIG__ = Object.assign({}, window.__GLOVIERA_CONFIG__ || {});
    window.__GLOVIERA_CONFIG__.mockPayments = window.__GLOVIERA_CONFIG__.mockPayments ?? true;
    window.__GLOVIERA_CONFIG__.allowMockOnFailure = window.__GLOVIERA_CONFIG__.allowMockOnFailure ?? true;
    window.GLOVIERA_FORCE_PAYMENT_MOCK = window.GLOVIERA_FORCE_PAYMENT_MOCK ?? true;
    window.GLOVIERA_ORDER_WEBHOOK = window.GLOVIERA_ORDER_WEBHOOK ||
      'https://script.google.com/macros/s/AKfycbyahuy1wdz4eAd0cpuwdfpk794RxZlGk-8767V04Vz_x3KHpoAdEkCcVgsaPA5T3Kz8ng/exec';
  </script>
  <style>
    :root {
      --glo-bg: #f8f1e5;
      --glo-gold: #fcb100;
      --glo-dark: #1c1a1a;
      --glo-text: #4f2222;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Vesper Libre', 'Georgia', serif;
      background: var(--glo-bg);
      color: var(--glo-text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: calc(env(safe-area-inset-top, 0px) + 18px) 20px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255,255,255,0.9);
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      position: sticky;
      top: 0;
      z-index: 20;
    }
    header .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      font-size: 0.95rem;
    }
    header img {
      width: 42px;
      height: 42px;
    }
    header a.back-link {
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.18em;
      text-decoration: none;
      color: var(--glo-text);
    }
    main {
      flex: 1;
      padding: 30px 16px 40px;
      display: flex;
      justify-content: center;
    }
    .checkout-card {
      width: 100%;
      max-width: 520px;
      background: rgba(255,255,255,0.98);
      border-radius: 20px;
      padding: 26px 24px 30px;
      box-shadow: 0 30px 90px rgba(76,28,28,0.15);
    }
    h1 {
      margin: 0 0 10px;
      font-size: 1.8rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .lead {
      margin: 0 0 20px;
      color: rgba(79,34,34,0.75);
      line-height: 1.6;
    }
    .payment-options {
      display: grid;
      gap: 10px;
    }
    .payment-option {
      border: 1px solid rgba(106,3,3,0.2);
      border-radius: 12px;
      padding: 12px 14px;
      background: rgba(255, 242, 222, 0.9);
      display: flex;
      flex-direction: column;
      gap: 4px;
      cursor: pointer;
      transition: border-color 0.2s ease, transform 0.2s ease;
    }
    .payment-option.active {
      border-color: #6a0303;
      background: rgba(237,154,154,0.16);
      box-shadow: 0 12px 26px rgba(106,3,3,0.12);
    }
    .payment-option-title {
      font-weight: 700;
      letter-spacing: 0.08em;
      font-size: 0.95rem;
      text-transform: uppercase;
    }
    .payment-option-copy {
      font-size: 0.86rem;
      color: rgba(79,34,34,0.78);
    }
    .payment-form {
      margin-top: 18px;
      display: grid;
      gap: 14px;
    }
    .payment-row { display: grid; gap: 6px; }
    .payment-row label {
      font-size: 0.78rem;
      font-weight: 700;
      letter-spacing: 0.14em;
      text-transform: uppercase;
    }
    .payment-row input,
    .payment-row select,
    .payment-row textarea {
      border: 1px solid rgba(106,3,3,0.25);
      border-radius: 10px;
      padding: 10px 12px;
      font-family: inherit;
      font-size: 0.95rem;
      background: rgba(255,255,255,0.95);
    }
    textarea { resize: vertical; }
    .payment-summary {
      border: 1px solid rgba(106,3,3,0.18);
      border-radius: 12px;
      padding: 14px 16px;
      background: rgba(255,255,255,0.9);
      display: grid;
      gap: 8px;
      font-weight: 600;
      font-size: 0.95rem;
    }
    .payment-summary hr {
      border: none;
      border-top: 1px dashed rgba(106,3,3,0.2);
      margin: 6px 0;
    }
    .payment-confirm {
      border: none;
      background: linear-gradient(135deg, var(--glo-gold), #de9603);
      color: var(--glo-dark);
      padding: 12px 18px;
      border-radius: 999px;
      font-weight: 700;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      cursor: pointer;
    }
    .payment-confirm:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .payment-alert {
      min-height: 18px;
      font-size: 0.9rem;
      color: #b10f0f;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: rgba(79,34,34,0.6);
    }
    footer {
      text-align: center;
      padding: 18px;
      font-size: 0.85rem;
      color: rgba(76,28,28,0.6);
    }
    .hidden { display: none !important; }
    @media (max-width: 520px) {
      .checkout-card { padding: 20px 18px 26px; }
      header { flex-direction: column; gap: 6px; }
    }
  </style>
</head>
<body>
  <header>
    <a class="back-link" href="index.html">← Back to product</a>
    <div class="brand">
      <img src="../images/logo.png" alt="Gloviéra" />
      <span>Checkout</span>
    </div>
  </header>
  <main>
    <div class="checkout-card">
      <div class="badge">Complete Your Ritual</div>
      <h1>Pay &amp; Reserve</h1>
      <p class="lead">Secure your Gloviéra Rice Water Face Wash and choose between an in-salon ritual or home delivery.</p>
      <div class="payment-options">
        <button type="button" class="payment-option active" data-method="Salon">
          <span class="payment-option-title">Pay Now for Salon</span>
          <span class="payment-option-copy">Visit our salon experience and pay only the product price.</span>
        </button>
        <button type="button" class="payment-option" data-method="Delivery">
          <span class="payment-option-title">Pay Now for Delivery</span>
          <span class="payment-option-copy">Enjoy doorstep delivery with a transparent fee.</span>
        </button>
      </div>
      <form class="payment-form" id="checkoutForm">
        <div class="payment-row">
          <label for="paymentName">Full Name</label>
          <input id="paymentName" name="customerName" type="text" placeholder="Enter your name" autocomplete="name" required />
        </div>
        <div class="payment-row">
          <label for="paymentEmail">Email</label>
          <input id="paymentEmail" name="customerEmail" type="email" placeholder="you@example.com" autocomplete="email" required />
        </div>
        <div class="payment-row">
          <label for="paymentQuantity">Quantity</label>
          <input id="paymentQuantity" type="number" min="1" max="5" value="1" inputmode="numeric" />
          <small class="payment-hint">Maximum of 5 facewash per order.</small>
        </div>
        <div class="payment-row hidden" data-address-row>
          <label for="paymentAddress">Full Delivery Address</label>
          <textarea id="paymentAddress" rows="3" placeholder="House no., street, area" autocomplete="street-address"></textarea>
          <small class="payment-hint">Include house number, street, city, and any nearby landmark.</small>
        </div>
        <div class="payment-row hidden" data-state-row>
          <label for="paymentState">State</label>
          <select id="paymentState"></select>
        </div>
        <div class="payment-row hidden" data-phone-row>
          <label for="paymentPhone">Phone Number</label>
          <input id="paymentPhone" type="text" inputmode="tel" maxlength="15" placeholder="10-digit mobile number" autocomplete="tel" />
        </div>
        <div class="payment-row hidden" data-pincode-row>
          <label for="paymentPincode">Pincode</label>
          <input id="paymentPincode" type="text" inputmode="numeric" maxlength="6" placeholder="6-digit pincode" autocomplete="postal-code" />
          <small class="payment-hint">Share the 6-digit postal code for your delivery address.</small>
        </div>
        <div class="payment-summary">
          <div><span>Unit Price</span><strong data-unit-price>₹0.00</strong></div>
          <div><span>Quantity</span><strong data-quantity-display>1</strong></div>
          <div><span>Product Subtotal</span><strong data-product-total>₹0.00</strong></div>
          <div><span>Delivery Fee</span><strong data-delivery-fee>₹0.00</strong></div>
          <hr />
          <div><span>Total Payable</span><strong data-final-amount>₹0.00</strong></div>
        </div>
        <div class="payment-alert" data-alert></div>
        <button type="submit" class="payment-confirm" data-confirm>Proceed to Pay</button>
      </form>
    </div>
  </main>
  <footer>© <strong>GLOVIÉRA</strong> — Glow Beyond Beauty</footer>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, doc, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC6LazuKUJqQw7JP1LHcI_z0S0MzyNg37Y",
      authDomain: "gloviera-e1c92.firebaseapp.com",
      projectId: "gloviera-e1c92",
      storageBucket: "gloviera-e1c92.firebasestorage.app",
      messagingSenderId: "980915433413",
      appId: "1:980915433413:web:dcfd8fedd54b94e73a65ac",
      measurementId: "G-FRT3966GSY"
    };

    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const CHECKOUT_PRODUCT = {
      productName: "Gloviéra Rice Water Face Wash",
      basePrice: 484,
      orderYear: 2025,
      orderPrefix: "GPF"
    };

    const MAX_FACEWASH_PER_ORDER = 5;
    const DELIVERY_ORDER_PREFIX = "GPF";

    const ORDER_AUTOMATION_ENDPOINT =
      (window.__GLOVIERA_CONFIG__ && window.__GLOVIERA_CONFIG__.orderAutomationWebhook) ||
      window.GLOVIERA_ORDER_WEBHOOK ||
      "";

    const API_BASE_URL =
      (window.__GLOVIERA_CONFIG__ && window.__GLOVIERA_CONFIG__.apiBaseUrl) ||
      (window.location.hostname === "localhost" ? "http://localhost:5000" : window.location.origin);

    const currencyFormatter = new Intl.NumberFormat("en-IN", {
      style: "currency",
      currency: "INR",
      maximumFractionDigits: 2
    });

    const INDIAN_STATES = [
      "Andhra Pradesh","Arunachal Pradesh","Assam","Bihar","Chhattisgarh","Goa","Gujarat","Haryana","Himachal Pradesh","Jharkhand","Karnataka","Kerala","Madhya Pradesh","Maharashtra","Manipur","Meghalaya","Mizoram","Nagaland","Odisha","Punjab","Rajasthan","Sikkim","Tamil Nadu","Telangana","Tripura","Uttar Pradesh","Uttarakhand","West Bengal","Andaman and Nicobar Islands","Chandigarh","Dadra and Nagar Haveli and Daman and Diu","Delhi","Jammu and Kashmir","Ladakh","Lakshadweep","Puducherry"
    ];

    const methodButtons = Array.from(document.querySelectorAll('.payment-option'));
    const stateRow = document.querySelector('[data-state-row]');
    const stateSelect = document.getElementById('paymentState');
    const addressRow = document.querySelector('[data-address-row]');
    const addressInput = document.getElementById('paymentAddress');
    const phoneRow = document.querySelector('[data-phone-row]');
    const phoneInput = document.getElementById('paymentPhone');
    const pincodeRow = document.querySelector('[data-pincode-row]');
    const pincodeInput = document.getElementById('paymentPincode');
    const quantityInput = document.getElementById('paymentQuantity');
    const quantityDisplay = document.querySelector('[data-quantity-display]');
    const productTotalEl = document.querySelector('[data-product-total]');
    const deliveryFeeEl = document.querySelector('[data-delivery-fee]');
    const finalAmountEl = document.querySelector('[data-final-amount]');
    const unitPriceEl = document.querySelector('[data-unit-price]');
    const alertBox = document.querySelector('[data-alert]');
    const confirmBtn = document.querySelector('[data-confirm]');
    const form = document.getElementById('checkoutForm');

    INDIAN_STATES.forEach((state) => {
      const option = document.createElement('option');
      option.value = state;
      option.textContent = state;
      stateSelect.appendChild(option);
    });

    unitPriceEl.textContent = formatMoney(CHECKOUT_PRODUCT.basePrice);

    let selectedMethod = 'Salon';
    let deliveryFee = 0;

    function formatMoney(value) {
      return currencyFormatter.format(Number(value || 0));
    }

    function clampQuantity(value) {
      const parsed = Number.parseInt(value, 10);
      if (Number.isNaN(parsed) || parsed < 1) return 1;
      if (parsed > MAX_FACEWASH_PER_ORDER) return MAX_FACEWASH_PER_ORDER;
      return parsed;
    }

    function setDeliveryRequirements(isRequired) {
      stateSelect.required = isRequired;
      addressInput.required = isRequired;
      phoneInput.required = isRequired;
      pincodeInput.required = isRequired;
    }

    function updateTotals() {
      const quantity = clampQuantity(quantityInput.value);
      if (String(quantity) !== String(quantityInput.value)) {
        quantityInput.value = quantity;
      }
      const quantityNumber = quantity || 1;

      if (selectedMethod === 'Delivery') {
        const chosenState = (stateSelect.value || '').trim().toLowerCase();
        deliveryFee = chosenState === 'punjab' ? 60 : 150;
        stateRow.classList.remove('hidden');
        addressRow.classList.remove('hidden');
        phoneRow.classList.remove('hidden');
        pincodeRow.classList.remove('hidden');
        setDeliveryRequirements(true);
      } else {
        deliveryFee = 0;
        stateRow.classList.add('hidden');
        addressRow.classList.add('hidden');
        phoneRow.classList.add('hidden');
        pincodeRow.classList.add('hidden');
        stateSelect.value = '';
        addressInput.value = '';
        phoneInput.value = '';
        pincodeInput.value = '';
        setDeliveryRequirements(false);
      }

      quantityDisplay.textContent = String(quantityNumber);
      const subtotal = CHECKOUT_PRODUCT.basePrice * quantityNumber;
      productTotalEl.textContent = formatMoney(subtotal);
      deliveryFeeEl.textContent = formatMoney(deliveryFee);
      finalAmountEl.textContent = formatMoney(subtotal + deliveryFee);
    }

    methodButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        if (btn.dataset.method === selectedMethod) return;
        methodButtons.forEach((b) => b.classList.remove('active'));
        btn.classList.add('active');
        selectedMethod = btn.dataset.method || 'Salon';
        updateTotals();
      });
    });

    quantityInput.addEventListener('input', () => { alertBox.textContent = ''; updateTotals(); });
    quantityInput.addEventListener('change', updateTotals);
    stateSelect.addEventListener('change', updateTotals);
    updateTotals();

    async function reserveDeliveryOrderNumber({ year, prefix = DELIVERY_ORDER_PREFIX }) {
      const normalizedYear = Number.isFinite(year) && year > 0 ? Math.trunc(year) : new Date().getFullYear();
      const safePrefix = (prefix || DELIVERY_ORDER_PREFIX || 'GPF').toUpperCase();
      const counterId = `${safePrefix.toLowerCase()}-${normalizedYear}`;
      const counterRef = doc(db, 'orderCounters', counterId);

      const sequence = await runTransaction(db, async (transaction) => {
        const snapshot = await transaction.get(counterRef);
        const current = snapshot.exists() ? Number(snapshot.data().sequence || 0) : 0;
        const next = current + 1;
        if (snapshot.exists()) {
          transaction.update(counterRef, {
            sequence: next,
            updatedAt: serverTimestamp()
          });
        } else {
          transaction.set(counterRef, {
            sequence: next,
            year: normalizedYear,
            prefix: safePrefix,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
        }
        return next;
      });

      return {
        sequence,
        year: normalizedYear,
        prefix: safePrefix,
        orderNumber: `${safePrefix}-${normalizedYear}-${sequence}`
      };
    }

    async function notifyOrderAutomation(payload) {
      if (!ORDER_AUTOMATION_ENDPOINT) return { skipped: true };
      try {
        await fetch(ORDER_AUTOMATION_ENDPOINT, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify(payload)
        });
        return { success: true };
      } catch (error) {
        console.warn('Order automation webhook failed', error);
        return { success: false, error };
      }
    }

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      alertBox.textContent = '';

      const name = document.getElementById('paymentName').value.trim();
      const email = document.getElementById('paymentEmail').value.trim();
      const stateValue = stateSelect.value.trim();
      const addressValue = addressInput.value.trim();
      const phoneValue = phoneInput.value.trim();
      const pincodeValue = pincodeInput.value.trim();
      const quantityRaw = quantityInput.value;
      const quantity = clampQuantity(quantityRaw);

      if (!name) { alertBox.textContent = 'Please enter your name.'; return; }
      const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailPattern.test(email)) { alertBox.textContent = 'Please enter a valid email.'; return; }
      if (!quantity || quantity < 1) { alertBox.textContent = 'Select at least one product.'; updateTotals(); return; }
      if (Number(quantityRaw) > MAX_FACEWASH_PER_ORDER) {
        alertBox.textContent = `You can order up to ${MAX_FACEWASH_PER_ORDER} units per order.`;
        quantityInput.value = String(MAX_FACEWASH_PER_ORDER);
        updateTotals();
        return;
      }

      if (selectedMethod === 'Delivery') {
        if (!stateValue) { alertBox.textContent = 'Choose your state for delivery calculations.'; return; }
        if (addressValue.length < 8) { alertBox.textContent = 'Enter your full delivery address.'; return; }
        if (!/^\d{10}$/.test(phoneValue)) { alertBox.textContent = 'Enter a valid 10-digit phone number.'; return; }
        if (!/^\d{6}$/.test(pincodeValue)) { alertBox.textContent = 'Enter a valid 6-digit pincode.'; return; }
      }

      const productSubtotal = CHECKOUT_PRODUCT.basePrice * quantity;
      const finalPrice = productSubtotal + deliveryFee;

      const deliveryDetails = selectedMethod === 'Delivery'
        ? { state: stateValue, address: addressValue, pincode: pincodeValue, phone: phoneValue }
        : { state: 'N/A', address: 'N/A', pincode: 'N/A', phone: '' };

      let orderNumberInfo = null;
      if (selectedMethod === 'Delivery') {
        try {
          orderNumberInfo = await reserveDeliveryOrderNumber({ year: CHECKOUT_PRODUCT.orderYear, prefix: CHECKOUT_PRODUCT.orderPrefix });
        } catch (counterError) {
          console.warn('Order number reservation failed', counterError);
          alertBox.textContent = "We couldn't generate an order number right now. Please try again in a moment.";
          return;
        }
      }

      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Processing…';

      const config = window.__GLOVIERA_CONFIG__ || {};
      const shouldMockPayments = Boolean(config.mockPayments || window.GLOVIERA_FORCE_PAYMENT_MOCK);
      const allowMockOnFailure = config.allowMockOnFailure !== false;

      try {
        let data;
        let usedMock = false;

        if (!shouldMockPayments) {
          try {
            const response = await fetch(`${API_BASE_URL}/api/payments/create`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                amount: finalPrice,
                currency: 'INR',
                metadata: {
                  productName: CHECKOUT_PRODUCT.productName,
                  unitPrice: CHECKOUT_PRODUCT.basePrice,
                  quantity,
                  productSubtotal,
                  deliveryFee,
                  finalPrice,
                  paymentMethod: selectedMethod,
                  orderYear: CHECKOUT_PRODUCT.orderYear,
                  orderPrefix: CHECKOUT_PRODUCT.orderPrefix,
                  orderNumber: orderNumberInfo?.orderNumber || null,
                  maxQuantityPerOrder: MAX_FACEWASH_PER_ORDER,
                  ...deliveryDetails
                },
                customer: { name, email, phone: deliveryDetails.phone }
              })
            });
            data = await response.json();
            if (!response.ok) {
              throw new Error(data?.message || 'Unable to start the payment. Please try again.');
            }
          } catch (networkError) {
            if (!allowMockOnFailure) {
              throw networkError;
            }
            console.warn('Gateway call failed, switching to mock flow.', networkError);
            usedMock = true;
          }
        } else {
          usedMock = true;
        }

        if (usedMock) {
          data = {
            merchantTransactionId: `mock_${Date.now()}`,
            redirectUrl: '',
            mock: true
          };
        }

        const orderId = data?.merchantTransactionId || `ord_${Date.now()}`;

        const orderRecord = {
          orderId,
          orderNumber: orderNumberInfo?.orderNumber || null,
          orderSequence: orderNumberInfo?.sequence ?? null,
          orderYear: CHECKOUT_PRODUCT.orderYear,
          orderPrefix: CHECKOUT_PRODUCT.orderPrefix,
          name,
          email,
          product: CHECKOUT_PRODUCT.productName,
          unitPrice: CHECKOUT_PRODUCT.basePrice,
          quantity,
          productSubtotal,
          deliveryFee,
          finalPrice,
          paymentMethod: selectedMethod,
          state: deliveryDetails.state,
          address: deliveryDetails.address,
          pincode: deliveryDetails.pincode,
          phone: deliveryDetails.phone,
          status: 'Payment Pending',
          reviewStatus: selectedMethod === 'Salon' ? 'Pending' : 'N/A',
          maxQuantityPerOrder: MAX_FACEWASH_PER_ORDER,
          automationWebhookConfigured: Boolean(ORDER_AUTOMATION_ENDPOINT),
          paymentMock: usedMock,
          createdAt: serverTimestamp()
        };

        try {
          await addDoc(collection(db, 'productOrders'), orderRecord);
        } catch (firestoreError) {
          console.warn('Unable to store order in Firestore', firestoreError);
        }

        const automationPayload = {
          event: 'product_order_initiated',
          orderId,
          orderNumber: orderNumberInfo?.orderNumber || '',
          orderSequence: orderNumberInfo?.sequence ?? null,
          orderYear: CHECKOUT_PRODUCT.orderYear,
          orderPrefix: CHECKOUT_PRODUCT.orderPrefix,
          paymentMethod: selectedMethod,
          status: 'Payment Pending',
          productName: CHECKOUT_PRODUCT.productName,
          quantity,
          unitPrice: CHECKOUT_PRODUCT.basePrice,
          productSubtotal,
          deliveryFee,
          finalPrice,
          maxQuantityPerOrder: MAX_FACEWASH_PER_ORDER,
          mockPayment: usedMock,
          customer: {
            name,
            email,
            phone: deliveryDetails.phone || '',
            state: deliveryDetails.state,
            address: deliveryDetails.address,
            pincode: deliveryDetails.pincode
          },
          reviewRequested: selectedMethod === 'Salon',
          emailTemplate: selectedMethod === 'Salon' ? 'salon_thank_you' : 'delivery_in_transit',
          paymentUrl: data?.redirectUrl || '',
          timestamp: new Date().toISOString()
        };

        await notifyOrderAutomation(automationPayload);

        if (data?.redirectUrl && !usedMock) {
          window.location.href = data.redirectUrl;
          return;
        }

        if (usedMock) {
          alert('Your order has been recorded. Expect a confirmation email shortly.');
        } else {
          alert('Payment initiated. Follow the gateway instructions to complete your order.');
        }

        form.reset();
        updateTotals();
      } catch (error) {
        console.error(error);
        alertBox.textContent = error.message || 'Failed to start the payment. Please try again.';
      } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Proceed to Pay';
      }
    });

    updateTotals();
  </script>
</body>
</html>
